# --- 以下为兼容ansible -b 运行的情况
# 恢复一些文件的o-r权限
- name: 修改ca-key, admin-key 的 o+r 权限
  file: path={{ ca_dir }}/{{ item }} mode="o-r"
  with_items:
  - ca-key.pem
  - admin-key.pem
  ignore_errors: true

- name: 修改calico-key.pem o+r 权限，方便分发
  file: path=/etc/calico/ssl/{{ item }} mode="o-r"
  with_items:
  - calico-key.pem
  ignore_errors: true

- name: 修改 kube-proxy.kubeconfig 的 o+r 权限
  file: path=/etc/kubernetes/kube-proxy.kubeconfig mode="o-r"
  ignore_errors: true

# - name: 修改 .kube/config 的 o+r 权限
#   file: path=/root/.kube/config mode="o-r"
#   ignore_errors: true

# - name: clean tmp .kube/config
#   file: name={{ item }} state=absent
#   with_items:
#   - "{{ ansible_env['PWD'] }}/.kube/"
#   ignore_errors: true

- name: 写入环境变量$PATH 
  lineinfile:
    dest: "{{ ansible_env['PWD'] }}/.bashrc"
    state: present
    regexp: 'kubeasz'
    line: 'export PATH={{ bin_dir }}:$PATH # generated by kubeasz'

- name: 添加 kubectl 命令自动补全
  lineinfile:
    dest: "{{ ansible_env['PWD'] }}/.bashrc"
    state: present
    regexp: 'kubectl completion'
    line: 'source <(kubectl completion bash)'

- name: 添加 helm 命令自动补全
  lineinfile:
    dest: "{{ ansible_env['PWD'] }}/.bashrc"
    state: present
    regexp: 'helm completion'
    line: 'source <(helm completion bash)'

# 为方便与tiller进行安全通信，启用helm tls环境变量；仅支持helm v2.11.0及以上版本
- name: 配置helm tls环境变量
  lineinfile:
    dest: "{{ ansible_env['PWD'] }}/.bashrc"
    state: present
    regexp: "helm tls environment"
    line: "export HELM_TLS_ENABLE=true"